import React from 'react';
import { useForm, useFieldArray, type SubmitHandler } from 'react-hook-form';
import { Plus, Trash2, Save, FileText, Search, Loader2, UserPlus } from 'lucide-react';
import type { VisitationFormData, VisitMotive } from '../types/form';
import type { Citizen } from '../services/citizenService';

const MOTIVES: { value: VisitMotive; label: string }[] = [
    { value: 'cadastramento_atualizacao', label: 'Cadastramento / Atualização' },
    { value: 'visita_periodica', label: 'Visita Periódica' },
    { value: 'busca_ativa', label: 'Busca Ativa' },
    { value: 'acompanhamento', label: 'Acompanhamento' },
    { value: 'controle_vetorial', label: 'Controle Vetorial' },
    { value: 'egresso_internacao', label: 'Egresso de Internação' },
    { value: 'convite_coletivo', label: 'Convite Ativ. Coletiva' },
    { value: 'orientacao_prevencao', label: 'Orientação / Prevenção' },
    { value: 'outros', label: 'Outros' },
];

interface VisitationFormProps {
    user?: any;
}

export const VisitationForm: React.FC<VisitationFormProps> = ({ user }) => {
    const [loadingSearch, setLoadingSearch] = React.useState<string | null>(null);
    motives: [],
        outcome: 'realized',
            shift: 'morning',
                microArea: user?.microArea || '',
                    propertyType: 'domicilio',
                        address: ''
}]
        }
    });

const { fields, append, remove } = useFieldArray({
    control,
    name: "visits"
});

const handleSearchCitizen = async (index: number) => {
    const cns = getValues(`visits.${index}.citizenCNS`);
    const name = getValues(`visits.${index}.citizenName`);

    if (!cns && !name) {
        alert('Preencha o CNS ou o Nome para pesquisar');
        return;
    }

    setLoadingSearch(fields[index].id);
    setCurrentVisitIndex(index);

    try {
        let results: Citizen[] = [];

        if (cns && cns.length === 15) {
            const { searchCitizenByCNS } = await import('../services/citizenService');
            const citizen = await searchCitizenByCNS(cns);
            if (citizen) results = [citizen];
        } else if (name && name.length >= 3) {
            const { searchCitizenByName } = await import('../services/citizenService');
            results = await searchCitizenByName(name);
        } else {
            alert('Digite pelo menos 3 caracteres no nome ou 15 dígitos no CNS');
            setLoadingSearch(null);
            return;
        }

        if (results.length > 0) {
            setSearchResults(results);
            setShowResultsModal(true);
        } else {
            setShowRegisterModal(true);
        }
    } catch (error) {
        console.error(error);
        alert('Erro ao buscar cidadão');
    } finally {
        setLoadingSearch(null);
    }
};

const selectCitizen = (citizen: Citizen) => {
    setValue(`visits.${currentVisitIndex}.citizenName`, citizen.name);
    setValue(`visits.${currentVisitIndex}.citizenCNS`, citizen.cns);
    setValue(`visits.${currentVisitIndex}.dateOfBirth`, citizen.dateOfBirth);
    if (citizen.address) {
        setValue(`visits.${currentVisitIndex}.address`, citizen.address);
    }
    setShowResultsModal(false);
    setSearchResults([]);
};

const handleRegisterCitizen = async () => {
    const name = (document.getElementById('newCitizenName') as HTMLInputElement)?.value;
    const dob = (document.getElementById('newCitizenDOB') as HTMLInputElement)?.value;
    const cns = (document.getElementById('newCitizenCNS') as HTMLInputElement)?.value;

    // Campos de endereço
    const cep = (document.getElementById('newCitizenCEP') as HTMLInputElement)?.value || '';
    const street = (document.getElementById('newCitizenStreet') as HTMLInputElement)?.value || '';
    const number = (document.getElementById('newCitizenNumber') as HTMLInputElement)?.value || '';
    const complement = (document.getElementById('newCitizenComplement') as HTMLInputElement)?.value || '';
    const neighborhood = (document.getElementById('newCitizenNeighborhood') as HTMLInputElement)?.value || '';
    const city = (document.getElementById('newCitizenCity') as HTMLInputElement)?.value || '';

    if (name && dob && cns) {
        // Montar endereço completo
        let fullAddress = '';
        if (street) fullAddress += street;
        if (number) fullAddress += `, ${number}`;
        if (complement) fullAddress += ` ${complement}`;
        if (neighborhood) fullAddress += `, ${neighborhood}`;
        if (city) fullAddress += `, ${city}`;
        if (cep) fullAddress += ` - CEP: ${cep}`;

        // Salvar cidadão permanentemente
        const { addCitizen } = await import('../services/citizenService');
        addCitizen({
            cns,
            name,
            dateOfBirth: dob,
            address: fullAddress
        });

        // Preencher campos da visita
        setValue(`visits.${currentVisitIndex}.citizenName`, name);
        setValue(`visits.${currentVisitIndex}.citizenCNS`, cns);
        setValue(`visits.${currentVisitIndex}.dateOfBirth`, dob);
        if (fullAddress) {
            setValue(`visits.${currentVisitIndex}.address`, fullAddress);
        }

        setShowRegisterModal(false);
        alert(`Cidadão ${name} cadastrado com sucesso!`);
    } else {
        alert('Preencha todos os campos obrigatórios (CNS, Nome e Data de Nascimento)');
    }
};

const handleSearchCEP = async (index: number) => {
    const cep = getValues(`visits.${index}.cep` as any)?.replace(/\D/g, '');
    if (!cep || cep.length !== 8) return;

    setLoadingCEP(fields[index].id);
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();

        if (!data.erro) {
            setValue(`visits.${index}.street` as any, data.logradouro);
            setValue(`visits.${index}.neighborhood` as any, data.bairro);
            setValue(`visits.${index}.city` as any, data.localidade);
        } else {
            alert('CEP não encontrado');
        }
    } catch (error) {
        console.error(error);
        alert('Erro ao buscar CEP');
    } finally {
        setLoadingCEP(null);
    }
};

const onSubmit: SubmitHandler<VisitationFormData> = (data) => {
    console.log(JSON.stringify(data, null, 2));
    alert('Dados salvos no console (F12)');
};

return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-8 p-4 max-w-4xl mx-auto bg-white shadow-lg rounded-lg my-8">
        <div className="bg-sus-blue text-white p-6 rounded-t-lg -m-4 mb-4">
            <div className="flex items-center gap-3 mb-4">
                <FileText className="w-8 h-8" />
                <h1 className="text-2xl font-bold">Ficha de Visita Domiciliar e Territorial</h1>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium mb-1 opacity-90">Profissional</label>
                    <input
                        {...register("professionalName", { required: true })}
                        readOnly
                        className="w-full p-2 rounded text-slate-900 bg-slate-100 cursor-not-allowed"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1 opacity-90">Data</label>
                    <input
                        type="date"
                        {...register("date", { required: true })}
                        className="w-full p-2 rounded text-slate-900"
                    />
                </div>
            </div>
        </div>

        <div className="space-y-6">
            {fields.map((field, index) => (
                <div key={field.id} className="border border-slate-200 rounded-lg p-4 bg-slate-50 relative">
                    <div className="absolute top-4 right-4">
                        <button
                            type="button"
                            onClick={() => remove(index)}
                            className="text-red-500 hover:text-red-700 p-1"
                        >
                            <Trash2 className="w-5 h-5" />
                        </button>
                    </div>

                    <h3 className="text-lg font-semibold text-sus-blue mb-4">Visita #{index + 1}</h3>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Turno</label>
                            <select {...register(`visits.${index}.shift`)} className="w-full p-2 border rounded">
                                <option value="morning">Manhã</option>
                                <option value="afternoon">Tarde</option>
                                <option value="night">Noite</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Microárea</label>
                            <input {...register(`visits.${index}.microArea`)} className="w-full p-2 border rounded" placeholder="00" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Tipo Imóvel</label>
                            <select {...register(`visits.${index}.propertyType`)} className="w-full p-2 border rounded">
                                <option value="domicilio">Domicílio</option>
                                <option value="comercio">Comércio</option>
                                <option value="terreno">Terreno Baldio</option>
                                <option value="ponto_estrategico">Ponto Estratégico</option>
                                <option value="escola">Escola</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Desfecho</label>
                            <select {...register(`visits.${index}.outcome`)} className="w-full p-2 border rounded">
                                <option value="realized">Realizada</option>
                                <option value="refused">Recusada</option>
                                <option value="absent">Ausente</option>
                            </select>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div className="md:col-span-2">
                            <label className="block text-sm font-medium text-slate-700 mb-1">Nome do Cidadão</label>
                            <div className="flex gap-2">
                                <input
                                    {...register(`visits.${index}.citizenName`)}
                                    className="flex-1 p-2 border rounded"
                                    placeholder="Nome completo"
                                />
                                <button
                                    type="button"
                                    onClick={() => handleSearchCitizen(index)}
                                    disabled={loadingSearch === field.id}
                                    className="bg-sus-blue text-white p-2 rounded hover:bg-blue-700 disabled:opacity-50"
                                    title="Pesquisar Cidadão"
                                >
                                    {loadingSearch === field.id ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}
                                </button>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Data Nasc.</label>
                            <input type="date" {...register(`visits.${index}.dateOfBirth`)} className="w-full p-2 border rounded" />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div className="md:col-span-2">
                            <label className="block text-sm font-medium text-slate-700 mb-1">CNS do Cidadão</label>
                            <input
                                {...register(`visits.${index}.citizenCNS`, {
                                    minLength: { value: 15, message: "CNS deve ter 15 dígitos" },
                                    maxLength: { value: 15, message: "CNS deve ter 15 dígitos" },
                                    pattern: { value: /^\d+$/, message: "Apenas números" }
                                })}
                                maxLength={15}
                                className="w-full p-2 border rounded"
                                placeholder="Cartão SUS (15 dígitos)"
                                onInput={(e) => {
                                    e.currentTarget.value = e.currentTarget.value.replace(/\D/g, '').slice(0, 15);
                                }}
                            />
                            {errors.visits?.[index]?.citizenCNS && <span className="text-red-500 text-xs">{errors.visits[index]?.citizenCNS?.message}</span>}
                        </div>
                    </div>

                    <div className="border-t pt-4 mt-4">
                        <h4 className="font-medium text-slate-700 mb-3">Endereço</h4>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">CEP</label>
                                <div className="flex gap-2">
                                    <input
                                        {...register(`visits.${index}.cep` as any)}
                                        maxLength={9}
                                        className="flex-1 p-2 border rounded"
                                        placeholder="00000-000"
                                        onInput={(e) => {
                                            let value = e.currentTarget.value.replace(/\D/g, '');
                                            if (value.length > 5) {
                                                value = value.slice(0, 5) + '-' + value.slice(5, 8);
                                            }
                                            e.currentTarget.value = value;
                                        }}
                                        onBlur={() => handleSearchCEP(index)}
                                    />
                                    <button
                                        type="button"
                                        onClick={() => handleSearchCEP(index)}
                                        disabled={loadingCEP === field.id}
                                        className="bg-slate-600 text-white p-2 rounded hover:bg-slate-700 disabled:opacity-50"
                                    >
                                        {loadingCEP === field.id ? <Loader2 className="w-4 h-4 animate-spin" /> : <Search className="w-4 h-4" />}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-slate-700 mb-1">Rua/Avenida</label>
                                <input
                                    {...register(`visits.${index}.street` as any)}
                                    className="w-full p-2 border rounded"
                                    placeholder="Nome da rua"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Número</label>
                                <input
                                    {...register(`visits.${index}.number` as any)}
                                    className="w-full p-2 border rounded"
                                    placeholder="Nº"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Complemento</label>
                                <input
                                    {...register(`visits.${index}.complement` as any)}
                                    className="w-full p-2 border rounded"
                                    placeholder="Apto, Bloco..."
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Bairro</label>
                                <input
                                    {...register(`visits.${index}.neighborhood` as any)}
                                    className="w-full p-2 border rounded"
                                    placeholder="Bairro"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Município</label>
                                <input
                                    {...register(`visits.${index}.city` as any)}
                                    className="w-full p-2 border rounded"
                                    placeholder="Cidade"
                                />
                            </div>
                        </div>
                    </div>

                    <div className="mb-4 mt-4">
                        <label className="block text-sm font-medium text-slate-700 mb-2">Motivo da Visita</label>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                            {MOTIVES.map((motive) => (
                                <label key={motive.value} className="flex items-center space-x-2 text-sm p-2 border rounded hover:bg-slate-100 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        value={motive.value}
                                        {...register(`visits.${index}.motives`)}
                                        className="rounded text-sus-blue"
                                    />
                                    <span>{motive.label}</span>
                                </label>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Peso (kg)</label>
                            <input
                                type="number"
                                step="0.1"
                                {...register(`visits.${index}.weight`, { valueAsNumber: true })}
                                className="w-full p-2 border rounded"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Altura (cm)</label>
                            <input
                                type="number"
                                {...register(`visits.${index}.height`, { valueAsNumber: true })}
                                className="w-full p-2 border rounded"
                            />
                        </div>
                    </div>
                </div>
            ))}
        </div>

        <div className="flex justify-between items-center pt-4 border-t">
            <button
                type="button"
                onClick={() => append({
                    id: crypto.randomUUID(),
                    motives: [],
                    outcome: 'realized',
                    shift: 'morning',
                    microArea: user?.microArea || '',
                    propertyType: 'domicilio',
                    address: ''
                })}
                className="flex items-center gap-2 text-sus-blue hover:bg-blue-50 px-4 py-2 rounded font-medium"
            >
                <Plus className="w-5 h-5" />
                Adicionar Visita
            </button>

            <button
                type="submit"
                className="flex items-center gap-2 bg-sus-green hover:bg-green-700 text-white px-6 py-2 rounded font-medium shadow-md"
            >
                <Save className="w-5 h-5" />
                Salvar Ficha
            </button>
        </div>

        {/* Modal de Resultados */}
        {showResultsModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 className="text-lg font-bold text-sus-blue mb-4">
                        Resultados da Busca ({searchResults.length} encontrado{searchResults.length > 1 ? 's' : ''})
                    </h3>

                    <div className="space-y-2">
                        {searchResults.map((citizen) => (
                            <div
                                key={citizen.cns}
                                onClick={() => selectCitizen(citizen)}
                                className="p-4 border rounded hover:bg-blue-50 cursor-pointer transition-colors"
                            >
                                <div className="font-medium text-slate-900">{citizen.name}</div>
                                <div className="text-sm text-slate-600">CNS: {citizen.cns}</div>
                                <div className="text-sm text-slate-600">Nascimento: {new Date(citizen.dateOfBirth).toLocaleDateString('pt-BR')}</div>
                                {citizen.address && <div className="text-sm text-slate-600">{citizen.address}</div>}
                            </div>
                        ))}
                    </div>

                    <div className="flex gap-2 mt-6">
                        <button
                            type="button"
                            onClick={() => {
                                setShowResultsModal(false);
                                setShowRegisterModal(true);
                            }}
                            className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-medium flex items-center justify-center gap-2"
                        >
                            <UserPlus className="w-4 h-4" />
                            Cadastrar Novo
                        </button>
                        <button
                            type="button"
                            onClick={() => {
                                setShowResultsModal(false);
                                setSearchResults([]);
                            }}
                            className="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 px-4 py-2 rounded font-medium"
                        >
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* Modal de Cadastro */}
        {showRegisterModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[85vh] overflow-y-auto">
                    <h3 className="text-lg font-bold text-sus-blue mb-4">Cadastro Rápido de Cidadão</h3>

                    <div className="space-y-3">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">CNS *</label>
                            <input
                                type="text"
                                id="newCitizenCNS"
                                maxLength={15}
                                className="w-full p-2 border rounded"
                                placeholder="15 dígitos"
                                defaultValue={getValues(`visits.${currentVisitIndex}.citizenCNS`) || ''}
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Nome Completo *</label>
                            <input
                                type="text"
                                id="newCitizenName"
                                className="w-full p-2 border rounded"
                                placeholder="Nome do cidadão"
                                defaultValue={getValues(`visits.${currentVisitIndex}.citizenName`) || ''}
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Data de Nascimento *</label>
                            <input
                                type="date"
                                id="newCitizenDOB"
                                className="w-full p-2 border rounded"
                            />
                        </div>

                        <div className="border-t pt-3 mt-3">
                            <h4 className="font-medium text-slate-700 mb-2 text-sm">Endereço (opcional)</h4>

                            <div className="space-y-2">
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-700 mb-1">CEP</label>
                                        <input
                                            type="text"
                                            id="newCitizenCEP"
                                            maxLength={9}
                                            className="w-full p-2 border rounded text-sm"
                                            placeholder="00000-000"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-700 mb-1">Número</label>
                                        <input
                                            type="text"
                                            id="newCitizenNumber"
                                            className="w-full p-2 border rounded text-sm"
                                            placeholder="Nº"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">Rua/Avenida</label>
                                    <input
                                        type="text"
                                        id="newCitizenStreet"
                                        className="w-full p-2 border rounded text-sm"
                                        placeholder="Nome da rua"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">Complemento</label>
                                    <input
                                        type="text"
                                        id="newCitizenComplement"
                                        className="w-full p-2 border rounded text-sm"
                                        placeholder="Apto, Bloco..."
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-700 mb-1">Bairro</label>
                                        <input
                                            type="text"
                                            id="newCitizenNeighborhood"
                                            className="w-full p-2 border rounded text-sm"
                                            placeholder="Bairro"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-700 mb-1">Município</label>
                                        <input
                                            type="text"
                                            id="newCitizenCity"
                                            className="w-full p-2 border rounded text-sm"
                                            placeholder="Cidade"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-2 mt-6">
                        <button
                            type="button"
                            onClick={handleRegisterCitizen}
                            className="flex-1 bg-sus-green hover:bg-green-700 text-white px-4 py-2 rounded font-medium"
                        >
                            Confirmar
                        </button>
                        <button
                            type="button"
                            onClick={() => setShowRegisterModal(false)}
                            className="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 px-4 py-2 rounded font-medium"
                        >
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        )}
    </form>
);
};
